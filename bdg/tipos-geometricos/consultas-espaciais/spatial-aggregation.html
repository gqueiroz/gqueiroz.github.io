<!DOCTYPE html>
<html class="writer-html5" lang="pt-BR" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.5.7. Agregação Espacial &mdash; BDGeo</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/table_styling.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/bd-geoespacial.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="canonical" href="https://prog-geo.github.io/tipos-geometricos/consultas-espaciais/spatial-aggregation.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Buscar" href="../../search.html" />
    <link rel="next" title="3.5.8. Consultas Gerais" href="general-queries.html" />
    <link rel="prev" title="3.5.6. Overlay de Mapas" href="overlay.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #F0F8FF" >
            <a href="../../index.html" class="icon icon-home"> BDGeo
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Pesquisar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Menu de navegação">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Bancos de Dados Geográficos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Aulas:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../instalacao/index.html">1. Instalando e Configurando o Ambiente de Trabalho</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sgbd/index.html">2. Sistemas de Bancos de Dados Relacionais</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">3. Tipos de Dados e Operações Espaciais</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introducao.html">3.1. Introdução</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ogc-sfs.html">3.2. Tipos Geométricos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rel-espaciais.html">3.3. Relacionamentos Espaciais</a></li>
<li class="toctree-l2"><a class="reference internal" href="../postgis-geometry.html">3.4. PostGIS Geometry</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">3.5. Consultas Espaciais</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="carga-dados.html">3.5.1. Carregando Dados no PostgreSQL/PostGIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="point-query.html">3.5.2. Consultas de Apontamento</a></li>
<li class="toctree-l3"><a class="reference internal" href="window-query.html">3.5.3. Consultas de Janela ou Intervalo</a></li>
<li class="toctree-l3"><a class="reference internal" href="proximity-query.html">3.5.4. Consultas de Proximidade</a></li>
<li class="toctree-l3"><a class="reference internal" href="spatial-join.html">3.5.5. Junção Espacial</a></li>
<li class="toctree-l3"><a class="reference internal" href="overlay.html">3.5.6. Overlay de Mapas</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.5.7. Agregação Espacial</a></li>
<li class="toctree-l3"><a class="reference internal" href="general-queries.html">3.5.8. Consultas Gerais</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../estrutura-dados/index.html">4. Estruturas de Dados e Métodos de Acesso Multidimensionais</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algo-geom/index.html">5. Algoritmos Geométricos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../json/index.html">6. JSON (Java Script Object Notation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prog-servidor/index.html">7. Programação do Lado Servidor no PostgreSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips/index.html">8. Dicas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Referências Bibliográficas</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../referencias.html">Referências Bibliográficas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Listas de Exercícios:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../listas.html">Listas de Exercícios</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Informações Gerais:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../licenca.html">Licença</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Agradecimentos:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agradecimentos.html">Agradecimentos</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Menu de navegação móvel"  style="background: #F0F8FF" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BDGeo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Navegação da página">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html"><span class="section-number">3. </span>Tipos de Dados e Operações Espaciais</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">3.5. </span>Consultas Espaciais</a> &raquo;</li>
      <li><span class="section-number">3.5.7. </span>Agregação Espacial</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Navegação sequencial da página">
        <a href="overlay.html" class="btn btn-neutral float-left" title="3.5.6. Overlay de Mapas" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="general-queries.html" class="btn btn-neutral float-right" title="3.5.8. Consultas Gerais" accesskey="n">Próximo <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="agregacao-espacial">
<span id="cap-tipos-geometricos-consultas-espaciais-spatial-agregation"></span><h1><span class="section-number">3.5.7. </span>Agregação Espacial<a class="headerlink" href="#agregacao-espacial" title="Link permanente para este cabeçalho"></a></h1>
<section id="consulta-1">
<h2><span class="section-number">3.5.7.1. </span>Consulta 1<a class="headerlink" href="#consulta-1" title="Link permanente para este cabeçalho"></a></h2>
<p><strong>Consulta:</strong> Gerar o mapa de Regiões do Brasil a partir do mapa de Unidades Federativas.</p>
<figure class="align-center align-default" id="fig-consultas-espaciais-spatial-agregation-agregacao-espacial">
<a class="reference internal image-reference" href="../../_images/agregacao-espacial.png"><img alt="Agregação Espacial - Mapas de Regiões a parir do Mapa de UF" src="../../_images/agregacao-espacial.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-number">Figura 3.49 - </span><span class="caption-text">Agregação Espacial - Mapas de Regiões a parir do Mapa de UF.</span><a class="headerlink" href="#fig-consultas-espaciais-spatial-agregation-agregacao-espacial" title="Link Permanente para essa imagem"></a></p>
</figcaption>
</figure>
<details class="summary-solucao">
<summary>Solução:</summary><p><br/></p>
<p>Podemos utilizar a função de agregação <code class="docutils literal notranslate"><span class="pre">ST_Union</span></code> para computar a geometria formada pela união de todos as geometrias de um grupo definido pela coluna <code class="docutils literal notranslate"><span class="pre">regiao_sig</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">regioes_brasil</span><span class="w"> </span><span class="k">AS</span><span class="w"></span>

<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="n">uf</span><span class="p">.</span><span class="n">regiao_sig</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sigla</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ST_Union</span><span class="p">(</span><span class="n">uf</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom</span><span class="w"></span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">uf</span><span class="w"></span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">regiao_sig</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Apesar do comando acima funcionar e gerar uma nova tabela chamada <code class="docutils literal notranslate"><span class="pre">regioes_brasil</span></code>, podemos notar que a estrutura da tabela, isto é, seu esquema, não terá  a coluna <code class="docutils literal notranslate"><span class="pre">geom</span></code> definida com os modificadores de subtipo geométrico e SRID. Verificando a estrutura da tabela:</p>
<div class="highlight-psql notranslate"><div class="highlight"><pre><span></span><span class="kp">\d</span><span class="w"> </span><span class="ss">regioes_brasil</span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                 Table &quot;public.regioes_brasil&quot;
 Column |         Type         | Collation | Nullable | Default
--------+----------------------+-----------+----------+---------
 sigla  | character varying(2) |           |          |
 geom   | geometry             |           |          |
</pre></div>
</div>
<p>Podemos notar que não foi definido automaticamente o SRID (4674) e o subtipo geométrico da coluna <code class="docutils literal notranslate"><span class="pre">geom</span></code>. Apesar das geometrias da tabela de entrada serem formadas apenas pelo tipo <code class="docutils literal notranslate"><span class="pre">MultiPolygon</span></code>, a função <code class="docutils literal notranslate"><span class="pre">ST_Union</span></code> irá gerar uma geometria do tipo mais simples possível. Nesse caso, teremos linhas com o tipo <code class="docutils literal notranslate"><span class="pre">MultiPolygon</span></code> ou <code class="docutils literal notranslate"><span class="pre">Polygon</span></code>. Podemos identificar isso através da seguinte consulta:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">ST_GeometryType</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">regioes_brasil</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> st_geometrytype
-----------------
 ST_MultiPolygon
 ST_Polygon
(2 rows)
</pre></div>
</div>
<p>Se nossa intenção é obter uma coluna geométrica de um tipo homogeneo, como o subtipo <code class="docutils literal notranslate"><span class="pre">MultiPolygon</span></code>, poderíamos aplicar a função <code class="docutils literal notranslate"><span class="pre">ST_Multi</span></code> ao resultado gerado pela função <code class="docutils literal notranslate"><span class="pre">ST_Union</span></code>, de maneira a garantir que a geometria final da região seja de uma coleção. Também incluiremos um <code class="docutils literal notranslate"><span class="pre">CAST</span></code> explícito, como mostrado no comando abaixo:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">regioes_brasil</span><span class="w"> </span><span class="k">AS</span><span class="w"></span>

<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="n">uf</span><span class="p">.</span><span class="n">regiao_sig</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sigla</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ST_Multi</span><span class="p">(</span><span class="w"> </span><span class="n">ST_Union</span><span class="p">(</span><span class="n">uf</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="p">)::</span><span class="n">geometry</span><span class="p">(</span><span class="n">MultiPolygon</span><span class="p">,</span><span class="w"> </span><span class="mi">4674</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom</span><span class="w"></span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">uf</span><span class="w"></span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">regiao_sig</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</details></section>
<hr class="docutils" />
<section id="consulta-2">
<h2><span class="section-number">3.5.7.2. </span>Consulta 2<a class="headerlink" href="#consulta-2" title="Link permanente para este cabeçalho"></a></h2>
<p><strong>Consulta:</strong> Utilizando os dados dos anos de 2017 e 2018 de focos, apresente uma contagem por bioma.</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>A primeira solução que vamos dar é construir uma consulta envolvendo as tabelas <code class="docutils literal notranslate"><span class="pre">focos</span></code> e <code class="docutils literal notranslate"><span class="pre">biomas</span></code> como mostrado abaixo:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">biomas</span><span class="p">.</span><span class="n">bioma</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bioma</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_focos</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">focos</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">biomas</span><span class="w"></span>
<span class="w">   </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ST_Contains</span><span class="p">(</span><span class="n">biomas</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">focos</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">biomas</span><span class="p">.</span><span class="n">bioma</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>     bioma      | total_focos
----------------+-------------
 Amazônia       |     2350680
 Caatinga       |      252185
 Cerrado        |     1677410
 Mata Atlântica |      314255
 Pampa          |       14015
 Pantanal       |       96295
(6 rows)
</pre></div>
</div>
<p>No meu sistema, a consulta acima é executada da seguinte forma:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"></span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="n">biomas</span><span class="mf">.</span><span class="n">bioma</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bioma</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_focos</span><span class="w"></span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">focos</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">biomas</span><span class="w"></span>
<span class="w">       </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ST_Contains</span><span class="p">(</span><span class="n">biomas</span><span class="mf">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">focos</span><span class="mf">.</span><span class="n">geom</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">biomas</span><span class="mf">.</span><span class="n">bioma</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                                                    QUERY PLAN

--------------------------------------------------------------------------------------------------------------------------------------------------
 HashAggregate  (cost=920634.25..920634.31 rows=6 width=17) (actual time=97122.996..97122.999 rows=6 loops=1)
   Group Key: biomas.bioma
   Batches: 1  Memory Usage: 24kB
   -&gt;  Nested Loop  (cost=147.82..780413.91 rows=28044069 width=9) (actual time=675.390..95716.016 rows=4704840 loops=1)
         -&gt;  Seq Scan on biomas  (cost=0.00..1.06 rows=6 width=3267257) (actual time=0.066..0.074 rows=6 loops=1)
         -&gt;  Bitmap Heap Scan on focos  (cost=147.82..130064.10 rows=471 width=32) (actual time=340.626..15829.862 rows=784140 loops=6)
               Filter: st_contains(biomas.geom, geom)
               Rows Removed by Filter: 1173152
               Heap Blocks: exact=217942
               -&gt;  Bitmap Index Scan on focos_geom_idx  (cost=0.00..147.70 rows=4705 width=0) (actual time=233.648..233.648 rows=1957292 loops=6)
                     Index Cond: (geom @ biomas.geom)
 Planning Time: 1.039 ms
 JIT:
   Functions: 10
   Options: Inlining true, Optimization true, Expressions true, Deforming true
   Timing: Generation 3.443 ms, Inlining 30.710 ms, Optimization 122.044 ms, Emission 34.748 ms, Total 190.945 ms
 Execution Time: 97131.554 ms
(17 rows)

Time: 97133.166 ms (01:37.133)
</pre></div>
</div>
<p>Ou seja, essa consulta é executada em aproximadamente 01 minuto e 37 segundos. Você saberia explicar onde essa consulta está gastando a maior parte do tempo?</p>
<p>Vamos agora tentar uma estratégia diferente, criando uma nova tabela com os biomas onde os polígonos são particionados em um conjunto de polígonos com um número menor de vértices, digamos 40:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">biomas_subdividido</span><span class="w"> </span><span class="k">AS</span><span class="w"></span>
<span class="w">       </span><span class="k">SELECT</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">bioma</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">ST_SubDivide</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mf">40</span><span class="p">)</span><span class="o">::</span><span class="n">geometry</span><span class="p">(</span><span class="nb">POLYGON</span><span class="p">,</span><span class="w"> </span><span class="mf">4674</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w"></span>
<span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="n">biomas</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">biomas_subdividido_geom_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">biomas_subdividido</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIST</span><span class="w"> </span><span class="p">(</span><span class="n">geom</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Agora, vamos verificar como a mesma consulta é realizada usando essa nova tabela:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"></span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="n">biomas</span><span class="mf">.</span><span class="n">bioma</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bioma</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_focos</span><span class="w"></span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">focos</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">biomas_subdividido</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">biomas</span><span class="w"></span>
<span class="w">       </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ST_Contains</span><span class="p">(</span><span class="n">biomas</span><span class="mf">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">focos</span><span class="mf">.</span><span class="n">geom</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">biomas</span><span class="mf">.</span><span class="n">bioma</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                                                              QUERY PLAN

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize GroupAggregate  (cost=3184627193.25..3184796844.98 rows=6 width=18) (actual time=5175.062..5421.178 rows=6 loops=1)
   Group Key: biomas.bioma
   -&gt;  Gather Merge  (cost=3184627193.25..3184796844.86 rows=12 width=18) (actual time=5154.357..5421.154 rows=18 loops=1)
         Workers Planned: 2
         Workers Launched: 2
         -&gt;  Partial GroupAggregate  (cost=3184626193.23..3184795843.45 rows=6 width=18) (actual time=5027.934..5198.022 rows=6 loops=3)
               Group Key: biomas.bioma
               -&gt;  Sort  (cost=3184626193.23..3184682743.28 rows=22620022 width=10) (actual time=4831.571..5068.800 rows=1568280 loops=3)
                     Sort Key: biomas.bioma
                     Sort Method: external merge  Disk: 28376kB
                     Worker 0:  Sort Method: external merge  Disk: 32792kB
                     Worker 1:  Sort Method: external merge  Disk: 29344kB
                     -&gt;  Nested Loop  (cost=0.41..3181089883.47 rows=22620022 width=10) (actual time=256.340..4276.527 rows=1568280 loops=3)
                           -&gt;  Parallel Seq Scan on biomas_subdividido biomas  (cost=0.00..3967.23 rows=27023 width=415) (actual time=0.022..7.081 rows=21618 loops=3)
                           -&gt;  Index Scan using focos_geom_idx on focos  (cost=0.41..117713.01 rows=471 width=32) (actual time=0.034..0.177 rows=73 loops=64855)
                                 Index Cond: (geom @ biomas.geom)
                                 Filter: st_contains(biomas.geom, geom)
                                 Rows Removed by Filter: 0
 Planning Time: 4.153 ms
 JIT:
   Functions: 36
   Options: Inlining true, Optimization true, Expressions true, Deforming true
   Timing: Generation 7.451 ms, Inlining 199.374 ms, Optimization 358.225 ms, Emission 202.490 ms, Total 767.540 ms
 Execution Time: 5429.893 ms
(24 rows)

Time: 5434.675 ms (00:05.435)
</pre></div>
</div>
<p>Repare que essa consulta é executada em pouco mais de 5 segundos! Você saberia dizer por que essa tabela de biomas com um número maior de linhas produz um resultado melhor do que a primeira solução que continha apenas 6 linhas?</p>
</details><hr class="docutils" />
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>As consultas desta seção também são conhecidas por <strong>Spatial Aggregation</strong>.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Rodapé">
        <a href="overlay.html" class="btn btn-neutral float-left" title="3.5.6. Overlay de Mapas" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="general-queries.html" class="btn btn-neutral float-right" title="3.5.8. Consultas Gerais" accesskey="n" rel="next">Próximo <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2022, Gilberto Queiroz.</p>
  </div>

  
<jinja2.runtime.BlockReference object at 0x7fdc27a6a520>
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/by-nc-sa.png" width="117" height="41"/></a> This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons “Attribution-NonCommercial-ShareAlike 4.0 International” license</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-165908761-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-165908761-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>