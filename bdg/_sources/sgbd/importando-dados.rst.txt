..
    This file is part of "Notas de Aula do Curso Bancos de Dados Geográficos".
    Copyright 2020-2022, Gilberto Queiroz.


.. _cap_sgbd_importando_dados:

Importando Dados
================


CSV
---


Considere o arquivo CSV mostrado abaixo, que contém dados sobre focos de queimada na vegetação localizados no município de São Félix do Xingu, no Pará, no dia 01 de setembro de 2022:


.. literalinclude:: ../data/csv/focos-sao-felix-do-xingu-20220901.csv
    :lines: 1-16
    :caption: :download:`focos-sao-felix-do-xingu-20220901.csv <../data/csv/focos-sao-felix-do-xingu-20220901.csv>`.
    :name: data:csv:focos-sao-felix-do-xingu-20220901


.. note::

    Os dados apresentados neste arquivo foram extraídos no `Portal de Dados Abertos do Programa Queimadas <https://queimadas.dgi.inpe.br/queimadas/dados-abertos/>`__.


Repare que esse arquivo possui uma primeira linha com um cabeçalho, indicando as colunas presentes:


.. code-block:: text

    id,lat,lon,data_hora_gmt,satelite,municipio,estado,pais,bioma,frp


Os campos encontram-se separados pelo caractere ``,``:


.. code-block:: text

    60e9d84c-b96e-3616-8433-5c4c979c5054,-9.45669,-51.60427,2022-09-01 01:34:00,TERRA_M-M,SÃO FÉLIX DO XINGU,PARÁ,Brasil,Amazônia,7.2


Vamos criar uma tabela capaz de armazenar os dados desse arquivo:


.. code-block:: sql

    CREATE TABLE focos
    (
        id             UUID,
        lat            DOUBLE PRECISION,
        lon            DOUBLE PRECISION,
        data_hora_gmt  TIMESTAMP WITHOUT TIME ZONE,
        satelite       VARCHAR(100),
        municipio      VARCHAR(100),
        estado         VARCHAR(100),
        pais           VARCHAR(100),
        bioma          VARCHAR(100),
        frp            DOUBLE PRECISION
    );


Para copiar o arquivo acima para a nova tabela criada, podemos utilizar o comando SQL ``COPY``, como mostrado abaixo:


.. code-block:: sql

    COPY focos(id, lat, lon, data_hora_gmt, satelite, municipio, estado, pais, bioma, frp)
    FROM '/data/focos-sao-felix-do-xingu-20220901.csv'
    DELIMITER ',' CSV HEADER;


No comando acima, o nome da tabela para onde importaremos o dado é especificado logo após a palavra chave ``COPY``. Se a tabela possuir as mesmas colunas do arquivo CSV, então podemos omitir a lista de colunas, caso contrário, as colunas para as quais copiaremos os dados deverão aperecer entre parênteses, como no exemplo acima. O caminho do arquivo CSV é colocado logo após a palavra chave ``FROM``. No caso de arquivos CSV, podemos especificar o delimitador e, opcionalmente, a existência de uma linha de cabeçalho.


Se o comando acima for bem sucedido, você receberá uma mensagem indicando que ``4122`` linhas foram copiadas para a tabela ``focos``.


.. note::

    Um detalhe importante é que o arquivo será lido pelo servidor PostgreSQL e, portanto, deve estar em um caminho acessível por ele.


.. note::

    O exemplo acima também poderia ser realizado sem especificar as colunas da tabela de destino:


    .. code-block:: sql

        COPY focos
        FROM '/data/focos-sao-felix-do-xingu-20220901.csv'
        DELIMITER ',' CSV HEADER;


.. note::

    O arquivo CVS completo com dados de focos de calor para o dia  01 de setembro de 2022 pode ser contrado :download:`aqui <https://queimadas.dgi.inpe.br/home/downloadfile?path=/app/api/data/dados_abertos/focos/Diario/focos_abertos_24h_20220901.csv>`.


.. tip::

    Para limpar a tabela, faça:


    .. code-block:: sql

        TRUNCATE TABLE focos RESTART IDENTITY;


O psql possui um meta-comando chamado ``\copy`` que pode ser usado de maneira análoga ao do comando SQL ``COPY``. A diferença essencial é que o ``\copy`` realiza a leitura do arquivo pelo cliente (psql), que envia os dados pela rede para o servidor. Portanto, o exemplo anterior poderia ser construído da seguinte forma:


.. code-block:: psql

    \copy focos FROM '/data/focos-sao-felix-do-xingu-20220901.csv' DELIMITER ',' CSV HEADER;


Importando pelo pgAdmin
+++++++++++++++++++++++


Pela interface gráfica do pgAdmin é possível importar arquivos CSV. Ao selecionar a tabela para a qual se deseja copiar os dados, selecione o meno ``Import/Export Data...``, como mostrado na figura abaixo:


.. figure:: ../img/pgadmin4/import-csv-01.png
    :alt: Importando dados para a tabela focos
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-01

    Importando dados para a tabela focos


Na janela aberta, com a opção ``Import`` selecionada, devemos indicar o arquivo a ser carregado:


.. figure:: ../img/pgadmin4/import-csv-02.png
    :alt: Importando dados para a tabela focos
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-02

    Importando dados para a tabela focos


O arquivo pode ser indicado de diversas formas. Uma delas consiste em fazer o upload do arquivo:


.. figure:: ../img/pgadmin4/import-csv-03.png
    :alt: Fazendo o upload de um arquivo CSV
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-03

    Importando dados para a tabela focos


.. figure:: ../img/pgadmin4/import-csv-04.png
    :alt: Fazendo o upload de um arquivo CSV
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-04

    Importando dados para a tabela focos


.. figure:: ../img/pgadmin4/import-csv-05.png
    :alt: Fazendo o upload de um arquivo CSV
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-05

    Importando dados para a tabela focos


.. figure:: ../img/pgadmin4/import-csv-06.png
    :alt: Fazendo o upload de um arquivo CSV
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-06

    Importando dados para a tabela focos


.. figure:: ../img/pgadmin4/import-csv-07.png
    :alt: Fazendo o upload de um arquivo CSV
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-07

    Importando dados para a tabela focos


.. figure:: ../img/pgadmin4/import-csv-08.png
    :alt: Fazendo o upload de um arquivo CSV
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-08

    Importando dados para a tabela focos


.. figure:: ../img/pgadmin4/import-csv-09.png
    :alt: Fazendo o upload de um arquivo CSV
    :width: 100%
    :figclass: align-center
    :name: fig:sgbd:import-csv-09

    Importando dados para a tabela focos
