<!DOCTYPE html>
<html class="writer-html5" lang="pt-BR" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2.15. Consultas em SQL &mdash; BDGeo</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/table_styling.css" type="text/css" />
      <link rel="stylesheet" href="../_static/bd-geoespacial.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="canonical" href="https://prog-geo.github.io/sgbd/consultas.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="../genindex.html" />
    <link rel="search" title="Buscar" href="../search.html" />
    <link rel="next" title="2.16. Atualizando Dados" href="atualizando-dados.html" />
    <link rel="prev" title="2.14. Inserindo Dados" href="inserindo-dados.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #F0F8FF" >
            <a href="../index.html" class="icon icon-home"> BDGeo
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Pesquisar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Menu de navegação">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Bancos de Dados Geográficos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Aulas:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../instalacao/index.html">1. Instalando e Configurando o Ambiente de Trabalho</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">2. Sistemas de Bancos de Dados Relacionais</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="postgresql.html">2.1. PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="pgadmin4.html">2.2. pgAdmin</a></li>
<li class="toctree-l2"><a class="reference internal" href="tour-sql.html">2.3. Um Tour pela Linguagem SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="conectando-bd.html">2.4. Conectando ao Servidor PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="criando-bd.html">2.5. Criando um Novo Banco de Dados no PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="tipos-dados-sql.html">2.6. Tipos de Dados SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="tipos-numericos.html">2.7. Tipos Numéricos</a></li>
<li class="toctree-l2"><a class="reference internal" href="tipo-logico.html">2.8. Tipo Lógico</a></li>
<li class="toctree-l2"><a class="reference internal" href="op-relacionais.html">2.9. Operadores Relacionais</a></li>
<li class="toctree-l2"><a class="reference internal" href="strings.html">2.10. Tipos Textuais</a></li>
<li class="toctree-l2"><a class="reference internal" href="tipos-data-hora.html">2.11. Tipos de Dados para Data e Hora</a></li>
<li class="toctree-l2"><a class="reference internal" href="expressoes.html">2.12. Expressões</a></li>
<li class="toctree-l2"><a class="reference internal" href="criando-tabelas.html">2.13. Criando Tabelas</a></li>
<li class="toctree-l2"><a class="reference internal" href="inserindo-dados.html">2.14. Inserindo Dados</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2.15. Consultas em SQL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#consultas-simples">2.15.1. Consultas Simples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#juncao-de-tabelas">2.15.2. Junção de Tabelas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#consultas-de-agregacao">2.15.3. Consultas de Agregação</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sub-consultas-sub-queries-ou-sub-selects">2.15.4. Sub-Consultas (Sub-Queries ou Sub-Selects)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#funcoes-de-janela-window-functions">2.15.5. Funções de Janela (Window Functions)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#criando-tabelas-a-partir-de-consultas">2.15.6. Criando Tabelas a partir de Consultas</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="atualizando-dados.html">2.16. Atualizando Dados</a></li>
<li class="toctree-l2"><a class="reference internal" href="removendo-dados.html">2.17. Removendo Dados</a></li>
<li class="toctree-l2"><a class="reference internal" href="restricoes-integridade.html">2.18. Restrições de Integridade</a></li>
<li class="toctree-l2"><a class="reference internal" href="criando-views.html">2.19. Criando Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="esquemas.html">2.20. Esquemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="alterando-estrutura.html">2.21. Alterando a Estrutura de uma Tabela</a></li>
<li class="toctree-l2"><a class="reference internal" href="import-export.html">2.22. Importando e Exportando Dados</a></li>
<li class="toctree-l2"><a class="reference internal" href="indexes.html">2.23. Índices - Estruturas de Acesso</a></li>
<li class="toctree-l2"><a class="reference internal" href="removendo-objetos.html">2.24. Removendo Objetos do Banco de Dados</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tipos-geometricos/index.html">3. Tipos de Dados e Operações Espaciais</a></li>
<li class="toctree-l1"><a class="reference internal" href="../estrutura-dados/index.html">4. Estruturas de Dados e Métodos de Acesso Multidimensionais</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algo-geom/index.html">5. Algoritmos Geométricos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../json/index.html">6. JSON (Java Script Object Notation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prog-servidor/index.html">7. Programação do Lado Servidor no PostgreSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tips/index.html">8. Dicas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Referências Bibliográficas</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../referencias.html">Referências Bibliográficas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Listas de Exercícios:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../listas.html">Listas de Exercícios</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Informações Gerais:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../licenca.html">Licença</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Agradecimentos:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../agradecimentos.html">Agradecimentos</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Menu de navegação móvel"  style="background: #F0F8FF" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BDGeo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Navegação da página">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">2. </span>Sistemas de Bancos de Dados Relacionais</a> &raquo;</li>
      <li><span class="section-number">2.15. </span>Consultas em SQL</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Navegação sequencial da página">
        <a href="inserindo-dados.html" class="btn btn-neutral float-left" title="2.14. Inserindo Dados" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="atualizando-dados.html" class="btn btn-neutral float-right" title="2.16. Atualizando Dados" accesskey="n">Próximo <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="consultas-em-sql">
<span id="cap-sgbd-consultas"></span><h1><span class="section-number">2.15. </span>Consultas em SQL<a class="headerlink" href="#consultas-em-sql" title="Link permanente para este cabeçalho"></a></h1>
<p>Na linguagem <code class="docutils literal notranslate"><span class="pre">SQL</span></code>, o comando <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> é utilizado para recuperação de dados das tabelas. A sintaxe geral deste comando é a seguinte:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>    SELECT [ ALL | DISTINCT [ ON ( expressão [, ...] ) ] ]
           [ * | expressão [ [ AS ] rótulo ] [, ...] ]

[     FROM from_item [, ...] ]

[    WHERE condição ]

[ GROUP BY elemento_agrupamento [, ...] ]

[   HAVING condição [, ...] ]

[ ORDER BY expressão [ ASC | DESC ] [, ...] ]

[    LIMIT { quantidade | ALL } ]

[   OFFSET início [ ROW | ROWS ] ]
</pre></div>
</div>
<p>O comando <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> é formado por várias cláusulas: <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, <code class="docutils literal notranslate"><span class="pre">FROM</span></code>, <code class="docutils literal notranslate"><span class="pre">WHERE</span></code>, <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>, <code class="docutils literal notranslate"><span class="pre">HAVING</span></code>, <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code>, <code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> e <code class="docutils literal notranslate"><span class="pre">OFFSET</span></code>. Cada uma dessas cláusulas tem um papel importante na definição dos objetivos de uma consulta. Portanto, na sintaxe mostrada acima temos que:</p>
<ul class="open">
<li><p>Tudo que está entre os pares de colchetes (<code class="docutils literal notranslate"><span class="pre">[</span></code> e <code class="docutils literal notranslate"><span class="pre">]</span></code>) é opcional.</p></li>
<li><p>A cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> permite especificar a lista de expressões, isto é, nomes de colunas ou fórmulas matemáticas ou chamadas de função ou até mesmo sub-consultas, que farão parte das linhas de saída da consulta. A palavra-chave <code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> faz com que linhas com valores duplicados sejam removidas do resultado, ficando apenas uma linha do grupo de linhas repetidas. <code class="docutils literal notranslate"><span class="pre">DISTINCT</span> <span class="pre">ON</span> <span class="pre">(</span> <span class="pre">expressão</span> <span class="pre">[,</span> <span class="pre">...])</span></code> tem um comportamento semelhante, mas considerando apenas a lista de expressões fornecida. A palavra-chave <code class="docutils literal notranslate"><span class="pre">ALL</span></code> inclui todas as linhas do resultado, que é o comportamento padrão e, portanto, pode ser omitida. A palavra-chave <code class="docutils literal notranslate"><span class="pre">AS</span></code> possibilita renomear uma coluna ou expressão com um novo <code class="docutils literal notranslate"><span class="pre">rótulo</span></code>. O caractere <code class="docutils literal notranslate"><span class="pre">*</span></code> é uma abreviação para a lista de todas as colunas dos conjuntos de dados presentes na cláusula <code class="docutils literal notranslate"><span class="pre">FROM</span></code>.</p></li>
<li><p>A cláusula <code class="docutils literal notranslate"><span class="pre">FROM</span></code> especifica uma ou mais tabelas como fonte dos dados da consulta. Caso múltiplas tabelas sejam especificadas, o resultado é um produto cartesiano (ou <code class="docutils literal notranslate"><span class="pre">CROSS</span> <span class="pre">JOIN</span></code>) de todas as tabelas envolvidas. No entanto, é muito comum o uso de uma cláusula <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> para restringir as linhas retornadas a um subconjunto menor desse produto cartesiano. Vale ressaltar que na cláusula <code class="docutils literal notranslate"><span class="pre">FROM</span></code>, o <code class="docutils literal notranslate"><span class="pre">from_item</span></code> pode ser o nome de uma tabela do banco de dados, o nome de uma <em>view</em> (visão), uma sub-consulta, ou até mesmo uma chamada de função que produza valores que são tratados como um conjunto de linhas. Portanto, a cláusula <code class="docutils literal notranslate"><span class="pre">FROM</span></code> faz o produto cartesiano dos conjuntos de dados informados.</p></li>
<li><p>A cláusula <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> permite definir uma <code class="docutils literal notranslate"><span class="pre">condição</span></code>, isto é, uma <code class="docutils literal notranslate"><span class="pre">expressão</span> <span class="pre">lógica</span></code> ou <code class="docutils literal notranslate"><span class="pre">predicado</span></code>, para filtrar o conjunto de linhas da consulta. As linhas que não satisfaçam esse predicado serão eliminadas do resultado.</p></li>
<li><p>A cláusula <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> é utilizada para criar grupos de linhas que são condensadas em uma única linha através das operações de agregação tais como: <code class="docutils literal notranslate"><span class="pre">SUM</span></code>, <code class="docutils literal notranslate"><span class="pre">MIN</span></code>, <code class="docutils literal notranslate"><span class="pre">MAX</span></code>, <code class="docutils literal notranslate"><span class="pre">AVG</span></code>, <code class="docutils literal notranslate"><span class="pre">COUNT</span></code>, entre outras. O <code class="docutils literal notranslate"><span class="pre">elemento_agrupamento</span></code> pode ser o nome de uma coluna ou uma expressão formada a partir das colunas. Também podemos usar os nomes das colunas de saída da consulta nessa cláusula ou até mesmo a posição ordinal da coluna de saída. Quando esta cláusula está presente, apenas as colunas listadas nela ou funções de agregação podem ser usadas na lista da cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>.</p></li>
<li><p>A cláusula <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> permite definir uma <code class="docutils literal notranslate"><span class="pre">condição</span></code>, isto é, uma <code class="docutils literal notranslate"><span class="pre">expressão</span> <span class="pre">lógica</span></code> ou <code class="docutils literal notranslate"><span class="pre">predicado</span></code>, para filtrar o resutado dos grupos de linhas. Dessa maneira, as linhas resultantes de agrupamentos que não satisfaçam essa condição, são eliminadas do resultado final.</p></li>
<li><p>A cláusula <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> ordena o resultado final de acordo com a expressão fornecida. Lembrando que a expressão pode ser uma lista de colunas, expressões matemáticas, chamadas de função, ou a posição das colunas de saída de acordo com a lista da cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>.</p></li>
<li><p>As cláusulas <code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> e <code class="docutils literal notranslate"><span class="pre">OFFSET</span></code> permitem, respectivamente, definir o número máximo de linhas a serem retornadas e o ponto onde esta contagem começa a valer.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>A sintaxe do comando de seleção apresentada acima foi feita de maneira simplificada. Para a versão completa, consulte o seguite tópico do manual do PostgreSQL: <a class="reference external" href="https://www.postgresql.org/docs/14/sql-select.html">SELECT</a>.</p>
</div>
<section id="consultas-simples">
<h2><span class="section-number">2.15.1. </span>Consultas Simples<a class="headerlink" href="#consultas-simples" title="Link permanente para este cabeçalho"></a></h2>
<p>Nesta seção veremos exemplos de consultas que envolvem uma única tabela como entrada.</p>
<p><strong>1.</strong> Recuperar os dados do estudante <code class="docutils literal notranslate"><span class="pre">Eduardo</span></code>:</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">nome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Eduardo&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula |  nome   | data_nascimento | genero | data_matricula
-----------+---------+-----------------+--------+----------------
         1 | Eduardo | 1980-08-04      | M      | 2019-01-01
(1 row)
</pre></div>
</div>
<p>Nessa consulta usamos três cláusulas:</p>
<ul class="open">
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code>: Nesta cláusula usamos o caracter especial <code class="docutils literal notranslate"><span class="pre">*</span></code> que é expandido para a lista de todas as colunas e, por isso, obtivemos uma linha com 05 valores como mostrado acima.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FROM</span></code>: Nesta cláusula especificamos a tabela <code class="docutils literal notranslate"><span class="pre">estudante</span></code> como fonte da consulta.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WHERE</span></code>: Nesta cláusula especificamos uma expressão lógica que realiza o filtro das linhas desejadas. No exemplo acima, temos apenas um estudante com o nome <code class="docutils literal notranslate"><span class="pre">Eduardo</span></code> e, portanto, somente uma linha satisfaz a condição <code class="docutils literal notranslate"><span class="pre">nome</span> <span class="pre">=</span> <span class="pre">'Eduardo'</span></code>.</p></li>
</ul>
</details><hr class="docutils" />
<p><strong>2.</strong> Recuperar o número de matrícula, nome e a data de matrícula dos estudantes do gênero feminino (<code class="docutils literal notranslate"><span class="pre">F</span></code>):</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">nome</span><span class="p">,</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">,</span><span class="w"> </span><span class="n">genero</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">genero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula |   nome    | data_matricula | genero
-----------+-----------+----------------+--------
         2 | Maria     | 2019-02-02     | F
         4 | Luiza     | 2020-01-05     | F
         5 | Ana Maria | 2020-01-05     | F
         6 | Ana Clara | 2020-01-05     | F
        11 | Carla     | 2019-01-05     | F
        12 | Telma     | 2020-01-06     | F
        14 | Lucia     | 2021-01-08     | F
        15 | Tassiana  | 2021-01-08     | F
        21 | Joana     | 2022-01-10     | F
        25 | Marcia    | 2022-01-11     | F
        28 | Katia     | 2022-01-12     | F
        30 | Zoraide   | 2022-01-12     | F
        31 | Roberta   | 2019-01-01     | F
        34 | Joana     | 2019-01-01     | F
        35 | Josi      | 2022-01-12     | F
(15 rows)
</pre></div>
</div>
<p>A cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> da consulta acima contém um subconjunto das colunas da tabela <code class="docutils literal notranslate"><span class="pre">estudante</span></code>: <code class="docutils literal notranslate"><span class="pre">matricula</span></code>, <code class="docutils literal notranslate"><span class="pre">nome</span></code>, <code class="docutils literal notranslate"><span class="pre">data_matricula</span></code> e <code class="docutils literal notranslate"><span class="pre">genero</span></code>. Utilizamos o separador <code class="docutils literal notranslate"><span class="pre">,</span></code> para listar as colunas nessa cláusula. Essa cláusula nos permite, entre outra coisas, controlar a ordem de apresentação das colunas.</p>
</details><hr class="docutils" />
<p><strong>3.</strong>  Recuperar o número de matrícula e os três primeiros caracteres do nome dos estudantes matriculados no ano de 2020 do gênero feminino (<code class="docutils literal notranslate"><span class="pre">F</span></code>):</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="k">left</span><span class="p">(</span><span class="n">nome</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">iniciais_nome</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">genero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | iniciais_nome
-----------+---------------
         4 | Lui
         5 | Ana
         6 | Ana
        12 | Tel
(4 rows)
</pre></div>
</div>
<p>Na consulta acima:</p>
<ul class="open">
<li><p>O segundo elemento da cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> utilizou uma função chamada <code class="docutils literal notranslate"><span class="pre">left</span></code> para extrair no máximo três caracteres de um nome. Nesse elemento, também utilizamos a palavra-chave <code class="docutils literal notranslate"><span class="pre">AS</span></code> para criar um novo rótulo para a coluna de saída: <code class="docutils literal notranslate"><span class="pre">iniciais_nome</span></code>.</p></li>
<li><p>A clausula <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> possui uma expressão usando o <strong>e-lógico</strong> (<code class="docutils literal notranslate"><span class="pre">AND</span></code>). Portanto, apenas as linhas que tenham simultaneamente o caracter <code class="docutils literal notranslate"><span class="pre">F</span></code> como gênero e a parte do ano da data de matricula igual a 2020 serão selecionadas no resultado final.</p></li>
</ul>
</details><hr class="docutils" />
<p><strong>4.</strong>  Recuperar o número de matrícula, o nome e a idade dos estudantes matriculados no ano de 2020 do gênero feminino (<code class="docutils literal notranslate"><span class="pre">F</span></code>):</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Para resolver esta consulta vamos precisar usar a função <code class="docutils literal notranslate"><span class="pre">age</span></code>, que computa um intervalo entre dois instantes de tempo. Considere o exemplo abaixo, onde usamos como referência o tempo do sistema atual (<code class="docutils literal notranslate"><span class="pre">CURRENT_TIMESTAMP</span></code>) e a data de <code class="docutils literal notranslate"><span class="pre">2000-02-01</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">age</span><span class="p">(</span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2000-02-01&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                   age
-----------------------------------------
 22 years 8 mons 13 days 19:42:10.241783
(1 row)
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Aviso</p>
<p>O exemplo acima deverá retornar um valor diferente dependendo da data e hora em que você estará executando a consulta!</p>
</div>
<p>Para tomar apenas a quantidade de anos entre as duas datas, podemos usar a função <code class="docutils literal notranslate"><span class="pre">extract</span></code>, como mostrado abaixo:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="w"> </span><span class="s1">&#39;year&#39;</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">age</span><span class="p">(</span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2000-02-01&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anos</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> anos
------
   22
(1 row)
</pre></div>
</div>
<p>Agora estamos prontos para construir a consulta final:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">nome</span><span class="p">,</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">age</span><span class="p">(</span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span><span class="w"> </span><span class="n">data_nascimento</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">idade</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">genero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula |   nome    | idade
-----------+-----------+-------
         4 | Luiza     |    41
         5 | Ana Maria |    41
         6 | Ana Clara |    41
        12 | Telma     |    39
(4 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>5.</strong>  Recuperar o número de matrícula e o nome dos estudantes cujo nome comece com as iniciais <code class="docutils literal notranslate"><span class="pre">jo</span></code>:</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">nome</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">lower</span><span class="p">(</span><span class="n">nome</span><span class="p">)</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;jo%&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | nome
-----------+-------
         8 | Jose
        21 | Joana
        34 | Joana
        35 | Josi
(4 rows)
</pre></div>
</div>
<p>Essa consulta utiliza o operador <code class="docutils literal notranslate"><span class="pre">LIKE</span></code>, que pode ser usado com strings. Este operador retorna verdadeiro caso a string à esquerda satisfaça o padrão fornecido à direita. O caractere <code class="docutils literal notranslate"><span class="pre">%</span></code> é um caractere especial, casando com qualquer sequencia de zero ou mais caracteres. Veja mais exemplos de uso desse operador abaixo:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;Gilberto&#39;</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%be%&#39;</span><span class="p">;</span><span class="w">       </span><span class="c1">-- retorna verdadeiro</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;Gilberta&#39;</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Gilbert_&#39;</span><span class="p">;</span><span class="w">   </span><span class="c1">-- retorna verdadeiro</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;Gilbertas&#39;</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Gilbert_&#39;</span><span class="p">;</span><span class="w">  </span><span class="c1">-- retorna falso</span>
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>6.</strong>  Recuperar o número de matrícula e o nome dos estudantes que tenham número de matrícula no conjunto <code class="docutils literal notranslate"><span class="pre">{1,</span> <span class="pre">3,</span> <span class="pre">5,</span> <span class="pre">12,</span> <span class="pre">14,</span> <span class="pre">17}</span></code>:</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">nome</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">matricula</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula |   nome
-----------+-----------
         1 | Eduardo
         3 | Eugenio
         5 | Ana Maria
        12 | Telma
        14 | Lucia
        17 | Felipe
(6 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>7.</strong>  Recuperar o número de matrícula e o nome dos estudantes que <strong>não</strong> estejam no conjunto de matrículas <code class="docutils literal notranslate"><span class="pre">{1,</span> <span class="pre">3,</span> <span class="pre">5,</span> <span class="pre">12,</span> <span class="pre">14,</span> <span class="pre">17}</span></code>:</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">nome</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">matricula</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>matricula |   nome
-----------+-----------
         2 | Maria
         4 | Luiza
         6 | Ana Clara
       ...   ...
        34 | Joana
        35 | Josi
        36 | Antonio
        37 | Zuleica
(31 rows)
</pre></div>
</div>
</details></section>
<hr class="docutils" />
<section id="juncao-de-tabelas">
<h2><span class="section-number">2.15.2. </span>Junção de Tabelas<a class="headerlink" href="#juncao-de-tabelas" title="Link permanente para este cabeçalho"></a></h2>
<p>Nesta seção veremos exemplos de consultas que envolvem duas ou mais tabelas como entrada.</p>
<p><strong>8.</strong> Fazer o produto cartesiano entre as tabelas <code class="docutils literal notranslate"><span class="pre">professor</span></code> e <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>:</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |   nome   | codigo |      titulo       | creditos | professor_codigo
--------+----------+--------+-------------------+----------+------------------
      1 | Romildo  |      1 | Matemática        |        6 |                1
      1 | Romildo  |      2 | Fisica            |        4 |                1
      1 | Romildo  |      3 | Bilogia           |        2 |                2
      1 | Romildo  |      4 | Quimica           |        3 |                3
      1 | Romildo  |      5 | Geografia         |        2 |                4
      1 | Romildo  |      6 | Historia          |        2 |                4
      1 | Romildo  |      7 | Lingua Portuguesa |        4 |                4
      1 | Romildo  |      8 | Lingua Inglesa    |        2 |                5
    ...   ...           ...   ...                      ...                ...
      6 | Cleiton  |      8 | Lingua Inglesa    |        2 |                5
      6 | Cleiton  |      9 | Lingua Francesa   |        1 |                5
      6 | Cleiton  |     10 | Ciências          |        1 |                4
(60 rows)
</pre></div>
</div>
<p>A cláusula <code class="docutils literal notranslate"><span class="pre">FROM</span></code> permite especificar uma lista de tabelas (ou itens de dados). Na consulta acima, a cláusula <code class="docutils literal notranslate"><span class="pre">FROM</span></code> realizou o produto cartesiano entre as duas tabelas. Como temos 06 professores e 10 discipllinas, o resultado contém 60 linhas, isto é, todas as linhas da tabela <code class="docutils literal notranslate"><span class="pre">professor</span></code> pareadas com todas as linhas da tabela <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>.</p>
<p>Repare também que por termos usado o caractere <code class="docutils literal notranslate"><span class="pre">*</span></code> na cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, todas as colunas das duas tabelas participaram do resultado final. Na cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> é possível controlar a lista de colunas de saída especificando o nome qualificado da coluna, isto é, o <code class="docutils literal notranslate"><span class="pre">nome-tabela.nome-coluna</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |   nome   |      titulo
--------+----------+-------------------
      1 | Romildo  | Matemática
      1 | Romildo  | Fisica
      1 | Romildo  | Bilogia
      1 | Romildo  | Quimica
      1 | Romildo  | Geografia
      1 | Romildo  | Historia
      1 | Romildo  | Lingua Portuguesa
      1 | Romildo  | Lingua Inglesa
    ...   ...        ...
      6 | Cleiton  | Lingua Inglesa
      6 | Cleiton  | Lingua Francesa
      6 | Cleiton  | Ciências
(60 rows)
</pre></div>
</div>
<p>Nesse último exemplo, o item <code class="docutils literal notranslate"><span class="pre">professor.*</span></code> na cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> é expandido para todas as colunas da tabela <code class="docutils literal notranslate"><span class="pre">professor</span></code>, isto é, as colunas <code class="docutils literal notranslate"><span class="pre">codigo</span></code> e <code class="docutils literal notranslate"><span class="pre">nome</span></code>. Já a expressão <code class="docutils literal notranslate"><span class="pre">disciplina.titulo</span></code> indica que queremos a coluna <code class="docutils literal notranslate"><span class="pre">titulo</span></code> da tabela <code class="docutils literal notranslate"><span class="pre">disciplina</span></code> no resultado.</p>
</details><hr class="docutils" />
<p><strong>9.</strong> Juntar as linhas correlatas das tabelas <code class="docutils literal notranslate"><span class="pre">professor</span></code> e <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>:</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Chamamos este tipo de consulta de <strong>junção entre tabelas</strong>.</p>
</div>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">professor_codigo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |   nome   | codigo |      titulo       | creditos | professor_codigo
--------+----------+--------+-------------------+----------+------------------
      1 | Romildo  |      1 | Matemática        |        6 |                1
      1 | Romildo  |      2 | Fisica            |        4 |                1
      2 | Thales   |      3 | Bilogia           |        2 |                2
      3 | Karine   |      4 | Quimica           |        3 |                3
      4 | Tamara   |      5 | Geografia         |        2 |                4
      4 | Tamara   |      6 | Historia          |        2 |                4
      4 | Tamara   |      7 | Lingua Portuguesa |        4 |                4
      5 | Carolina |      8 | Lingua Inglesa    |        2 |                5
      5 | Carolina |      9 | Lingua Francesa   |        1 |                5
      4 | Tamara   |     10 | Ciências          |        1 |                4
(10 rows)
</pre></div>
</div>
<p>Repare na saída acima que agora os valores nas linhas para a primeira coluna <code class="docutils literal notranslate"><span class="pre">codigo</span></code> são iguais na coluna <code class="docutils literal notranslate"><span class="pre">professor_codigo</span></code>. Esse exemplo mostra como usar colunas relacionadas para busca da informação apropriada.</p>
<p>Outra forma de realizar a consulta acima é utilizar a palavra-chave <code class="docutils literal notranslate"><span class="pre">INNER</span> <span class="pre">JOIN</span></code>, como indicado abaixo:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">professor_codigo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |   nome   | codigo |      titulo       | creditos | professor_codigo
--------+----------+--------+-------------------+----------+------------------
      1 | Romildo  |      1 | Matemática        |        6 |                1
      1 | Romildo  |      2 | Fisica            |        4 |                1
      2 | Thales   |      3 | Bilogia           |        2 |                2
      3 | Karine   |      4 | Quimica           |        3 |                3
      4 | Tamara   |      5 | Geografia         |        2 |                4
      4 | Tamara   |      6 | Historia          |        2 |                4
      4 | Tamara   |      7 | Lingua Portuguesa |        4 |                4
      5 | Carolina |      8 | Lingua Inglesa    |        2 |                5
      5 | Carolina |      9 | Lingua Francesa   |        1 |                5
      4 | Tamara   |     10 | Ciências          |        1 |                4
(10 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p id="cap-sgbd-consultas-10"><strong>10.</strong> Juntar as linhas correlatas das tabelas <code class="docutils literal notranslate"><span class="pre">professor</span></code> e <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>, exibindo também algum professor que não esteja associado a disciplinas:</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Neste caso será necessário utilizar um tipo de junção (<code class="docutils literal notranslate"><span class="pre">JOIN</span></code>) que garanta que as linhas da tabela <code class="docutils literal notranslate"><span class="pre">professor</span></code> apareçam no resultado pelo menos uma vez, mesmo não havendo correspondência na tabela <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>. O tipo de junção necessária é conhecida como <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">professor_codigo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |   nome   | codigo |      titulo       | creditos | professor_codigo
--------+----------+--------+-------------------+----------+------------------
      1 | Romildo  |      1 | Matemática        |        6 |                1
      1 | Romildo  |      2 | Fisica            |        4 |                1
      2 | Thales   |      3 | Bilogia           |        2 |                2
      3 | Karine   |      4 | Quimica           |        3 |                3
      4 | Tamara   |      5 | Geografia         |        2 |                4
      4 | Tamara   |      6 | Historia          |        2 |                4
      4 | Tamara   |      7 | Lingua Portuguesa |        4 |                4
      5 | Carolina |      8 | Lingua Inglesa    |        2 |                5
      5 | Carolina |      9 | Lingua Francesa   |        1 |                5
      4 | Tamara   |     10 | Ciências          |        1 |                4
<span class="hll">      6 | Cleiton  |        |                   |          |
</span>(11 rows)
</pre></div>
</div>
<p>Repare na saída acima que a linha (registro ou tupla) do professor <code class="docutils literal notranslate"><span class="pre">Cleiton</span></code> apareceu no resultado final, com as colunas da tabela <code class="docutils literal notranslate"><span class="pre">disciplina</span></code> preenchidas com valor nulo (<code class="docutils literal notranslate"><span class="pre">NULL</span></code>).</p>
</details><hr class="docutils" />
<p><strong>11.</strong> Liste os professores que não estão associados a disciplinas:</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Podemos utilizar uma estratégia semelhante à da <a class="reference internal" href="#cap-sgbd-consultas-10"><span class="std std-ref">consulta 10</span></a>, usando <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> entre as tabelas <code class="docutils literal notranslate"><span class="pre">professor</span></code> e <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>, acrescentando um predicado (ou filtro) com a cláusula <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> que verifique se o <code class="docutils literal notranslate"><span class="pre">codigo</span></code> da tabela <code class="docutils literal notranslate"><span class="pre">disciplina</span></code> é <code class="docutils literal notranslate"><span class="pre">NULL</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">professor_codigo</span><span class="w"></span>
<span class="hll"><span class="w">   </span><span class="k">WHERE</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"></span>
</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">nome</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |  nome   | codigo | titulo | creditos | professor_codigo
--------+---------+--------+--------+----------+------------------
      6 | Cleiton |        |        |          |
(1 row)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>12.</strong> Liste as linhas correlatas das tabelas <code class="docutils literal notranslate"><span class="pre">estudante</span></code> e <code class="docutils literal notranslate"><span class="pre">disciplina</span></code> bem como aquelas que não tiverem correspondência:</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Neste caso precisamos utilizar o <code class="docutils literal notranslate"><span class="pre">FULL</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> entre as tabelas <code class="docutils literal notranslate"><span class="pre">estudante</span></code>, <code class="docutils literal notranslate"><span class="pre">estudante_disciplina</span></code> e <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>, para que os estudantes que não estejam associados a disciplinas sejam listados, bem como as disciplinas que não tiverem estudantes associados:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">estudante</span><span class="p">.</span><span class="n">matricula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula |   nome    | data_nascimento | genero | data_matricula | matricula | codigo |    data    | codigo |      titulo       | creditos | professor_codigo
-----------+-----------+-----------------+--------+----------------+-----------+--------+------------+--------+-------------------+----------+------------------
         1 | Eduardo   | 1980-08-04      | M      | 2019-01-01     |         1 |      2 | 2019-06-01 |      2 | Fisica            |        4 |                1
         1 | Eduardo   | 1980-08-04      | M      | 2019-01-01     |         1 |      1 | 2019-06-01 |      1 | Matemática        |        6 |                1
         2 | Maria     | 1980-04-03      | F      | 2019-02-02     |         2 |      4 | 2019-06-01 |      4 | Quimica           |        3 |                3
       ...   ...         ...               ...      ...                    ...      ...   ...             ...   ...                      ...                ...
        36 | Antonio   | 1976-06-30      | M      | 2019-01-01     |        36 |      5 | 2019-06-01 |      5 | Geografia         |        2 |                4
<span class="hll">        37 | Zuleica   | 1986-06-30      | M      | 2019-01-01     |           |        |            |        |                   |          |
</span><span class="hll">           |           |                 |        |                |           |        |            |     10 | Ciências          |        1 |                4
</span>(75 rows)
</pre></div>
</div>
<p>Repare na saída acima que a estudante <code class="docutils literal notranslate"><span class="pre">Zuleica</span></code> não se encontra matriculada em nenhuma disciplina e que a disciplina de <code class="docutils literal notranslate"><span class="pre">Ciências</span></code> não possui estudante associado.</p>
</details><hr class="docutils" />
<p><strong>13.</strong> Qual o nome das disciplinas cursadas pelo estudante <code class="docutils literal notranslate"><span class="pre">Eduardo</span></code>?</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">nome</span><span class="p">,</span><span class="w"> </span><span class="n">titulo</span><span class="w"></span>

<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="p">,</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="w"></span>

<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">matricula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">matricula</span><span class="w"></span>
<span class="w">   </span><span class="k">AND</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"></span>
<span class="w">   </span><span class="k">AND</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Eduardo&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula |  nome   |   titulo
-----------+---------+------------
         1 | Eduardo | Matemática
         1 | Eduardo | Fisica
(2 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>14.</strong> Qual o nome dos professores do estudante <code class="docutils literal notranslate"><span class="pre">Eduardo</span></code>?</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_estudante</span><span class="p">,</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_professor</span><span class="p">,</span><span class="w"> </span><span class="n">titulo</span><span class="w"></span>

<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="p">,</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">,</span><span class="w"> </span><span class="n">professor</span><span class="w"></span>

<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">matricula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">matricula</span><span class="w"></span>
<span class="w">   </span><span class="k">AND</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"></span>
<span class="w">   </span><span class="k">AND</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">professor_codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="w"></span>
<span class="w">   </span><span class="k">AND</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Eduardo&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | nome_estudante | nome_professor |   titulo
-----------+----------------+----------------+------------
         1 | Eduardo        | Romildo        | Matemática
         1 | Eduardo        | Romildo        | Fisica
(2 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<div class="admonition tip">
<p class="admonition-title">Dica</p>
<p>Para mais detalhes das consultas com junção entre tabelas, consulte o manual do PostgreSQL nas seções <a class="reference external" href="https://www.postgresql.org/docs/14/tutorial-join.html">2.6. Joins Between Tables</a> e <a class="reference external" href="https://www.postgresql.org/docs/14/queries-table-expressions.html">7.2. Table Expressions</a>.</p>
</div>
</section>
<section id="consultas-de-agregacao">
<h2><span class="section-number">2.15.3. </span>Consultas de Agregação<a class="headerlink" href="#consultas-de-agregacao" title="Link permanente para este cabeçalho"></a></h2>
<p>Temos vários operadores que trabalham com grupos de registros, sendo muito úteis para uso com a cláusula <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>:</p>
<ul class="open">
<li><p><code class="docutils literal notranslate"><span class="pre">AVG</span></code>: média dos valores da coluna.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SUM</span></code>: soma dos valores da coluna.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COUNT</span></code>: número de valores na coluna.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX</span></code>: maior valor na coluna.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MIN</span></code>: menor valor na coluna.</p></li>
</ul>
<p>Nesta seção vamos explorar o uso das cláusulas <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> e <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> na construção de consultas que permitam realizar uma sumarização de valores a partir de grupos de linhas.</p>
<p><strong>15.</strong> Quantos estudantes estão cadastrados?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Neste caso precisamos apenas usar uma função de agregação que conte o número de linhas de uma tabela, tratando todas as linhas como um único grupo. A função de agregação <code class="docutils literal notranslate"><span class="pre">COUNT</span></code> pode ser usada para esta finalidade:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> num_estudantes
----------------
             37
(1 row)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>16.</strong> Quantas são as disciplinas?</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">disciplina</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> num_disciplinas
-----------------
              10
(1 row)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>17.</strong> Quantos professores estão cadastrados?</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_professores</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> num_professores
-----------------
               6
(1 row)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>18.</strong> Qual o número de estudantes do sexo masculino e feminino?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>O número de estudantes do sexo masculino pode ser computado com a seguinte consulta:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes_masculino</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">genero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;M&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> num_estudantes_masculino
--------------------------
                       22
(1 row)
</pre></div>
</div>
<p>O número de estudantes do sexo feminino:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes_feminino</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">genero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> num_estudantes_feminino
-------------------------
                      15
(1 row)
</pre></div>
</div>
<p>Outra forma de computar os dois valores numa única consulta consiste em utilizar a cláusula <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> utilizando os valores da coluna <code class="docutils literal notranslate"><span class="pre">genero</span></code> para criação de dois grupos de linhas, como mostrado na <a class="reference internal" href="#fig-sgbd-consultas-estudante-group-by-genero"><span class="std std-numref">Figura 2.20</span></a>:</p>
<figure class="align-center align-default" id="fig-sgbd-consultas-estudante-group-by-genero">
<a class="reference internal image-reference" href="../_images/estudante-group-by-genero.png"><img alt="Tabela estudante com linhas agrupadas pelos valores da coluna genero" src="../_images/estudante-group-by-genero.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-number">Figura 2.20 - </span><span class="caption-text">Tabela <code class="docutils literal notranslate"><span class="pre">estudante</span></code> com linhas agrupadas pelos valores da coluna <code class="docutils literal notranslate"><span class="pre">genero</span></code></span><a class="headerlink" href="#fig-sgbd-consultas-estudante-group-by-genero" title="Link Permanente para essa imagem"></a></p>
</figcaption>
</figure>
<p>Desta forma, podemos construir a seguinte consulta:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">genero</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"></span>
</span><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>
<span class="hll"><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">genero</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> genero | num_estudantes
--------+----------------
 M      |             22
 F      |             15
(2 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>19.</strong> Qual o número de estudantes matriculados em cada ano?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Para esta consulta utilizaremos a cláusula <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> com os valores de ano da coluna <code class="docutils literal notranslate"><span class="pre">data_matricula</span></code>. A <a class="reference internal" href="#fig-sgbd-consultas-estudante-group-by-ano"><span class="std std-numref">Figura 2.21</span></a> mostra quais os grupos de linhas que serão gerados:</p>
<figure class="align-center align-default" id="fig-sgbd-consultas-estudante-group-by-ano">
<a class="reference internal image-reference" href="../_images/estudante-group-by-ano.png"><img alt="Tabela estudante com linhas agrupadas pelos valores do ano de matrícula" src="../_images/estudante-group-by-ano.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-number">Figura 2.21 - </span><span class="caption-text">Tabela <code class="docutils literal notranslate"><span class="pre">estudante</span></code> com linhas agrupadas pelos valores do ano da coluna <code class="docutils literal notranslate"><span class="pre">data_matricula</span></code></span><a class="headerlink" href="#fig-sgbd-consultas-estudante-group-by-ano" title="Link Permanente para essa imagem"></a></p>
</figcaption>
</figure>
<p>Consulta:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ano</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"></span>
</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"></span>

<span class="hll"><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"></span>
</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ano</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> ano  | num_estudantes
------+----------------
 2019 |             10
 2020 |              7
 2021 |              8
 2022 |             12
(4 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>20.</strong> Quantas disciplinas cada estudante cursa?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Para solução dessa consulta temos que considerar a diferença entre a função <code class="docutils literal notranslate"><span class="pre">COUNT(*)</span></code> e <code class="docutils literal notranslate"><span class="pre">COUNT(&quot;nome-coluna&quot;)</span></code>. A função <code class="docutils literal notranslate"><span class="pre">COUNT(*)</span></code> conta o número de registros em cada grupo independente de haver alguma coluna com valor NULL. A função <code class="docutils literal notranslate"><span class="pre">COUNT(&quot;nome-coluna&quot;)</span></code> permite definirmos a coluna que será utilizada para contagem e caso o valor seja nulo (<code class="docutils literal notranslate"><span class="pre">NULL</span></code>), essa linha não será considerada na contagem geral.</p>
<p>Além disso, temos que considerar que algum estudante pode não ter se matriculado em disciplinas. Neste caso precisaremos fazer um <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> entre a tabela <code class="docutils literal notranslate"><span class="pre">estudante</span></code> e <code class="docutils literal notranslate"><span class="pre">estudante_matricula</span></code>.</p>
<p>Abaixo mostramos uma consulta onde usamos as duas formas da função de agregação <code class="docutils literal notranslate"><span class="pre">COUNT</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="ss">&quot;codigo&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="w"></span>

<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Saída:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | num_disciplinas | num_disciplinas
-----------+-----------------+-----------------
         1 |               2 |               2
         2 |               3 |               3
         3 |               1 |               1
       ...               ...               ...
        35 |               1 |               1
        36 |               4 |               4
<span class="hll">        37 |               0 |               1
</span>(37 rows)
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Repare a diferença do resultado das formas da função de agregação <code class="docutils literal notranslate"><span class="pre">COUNT</span></code> na linha destacada acima.</p>
</div>
</details><hr class="docutils" />
<p id="cap-sgbd-consultas-21"><strong>21.</strong> Quais estudantes cursam três ou mais disciplinas?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Esta consulta precisará contar o número de disciplinas para cada estudante e em seguida aplicar um filtro no resultado do grupo. Isto indica que precisaremos utilizar a cláusula <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> como mostrado abaixo:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="ss">&quot;codigo&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="p">,</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ano</span><span class="w"></span>

<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="n">INNET</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="hll"><span class="w">  </span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="ss">&quot;codigo&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | num_disciplinas | ano
-----------+-----------------+------
         2 |               3 | 2019
         6 |               3 | 2020
         7 |               5 | 2020
         8 |               3 | 2020
        12 |               3 | 2020
        15 |               4 | 2021
        18 |               3 | 2021
        19 |               3 | 2021
        23 |               3 | 2022
        36 |               4 | 2019
(10 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>22.</strong> Quais estudantes matriculados no ano de 2020 cursam três ou mais disciplinas?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Esta consulta é muito parecida com a <a class="reference internal" href="#cap-sgbd-consultas-21"><span class="std std-ref">consulta 21</span></a>, com a diferença de que precisaremos acrescentar a cláusula <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> para selecionar os estudantes que sejam do ano de 2020:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="ss">&quot;codigo&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="w"></span>

<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="n">INNET</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>

<span class="hll"><span class="w">   </span><span class="k">WHERE</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="w"></span>
</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="hll"><span class="w">  </span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="ss">&quot;codigo&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | num_disciplinas
-----------+-----------------
         6 |               3
         7 |               5
         8 |               3
        12 |               3
(4 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>23.</strong> Qual o número de disciplinas oferecidas por cada professor?</p>
<details class="summary-solucao">
<summary>Solução:</summary><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">nome</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="w"></span>

<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">professor_codigo</span><span class="p">)</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">  </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">nome</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |   nome   | num_disciplinas
--------+----------+-----------------
      1 | Romildo  |               2
      2 | Thales   |               1
      3 | Karine   |               1
      4 | Tamara   |               4
      5 | Carolina |               2
      6 | Cleiton  |               0
(6 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p id="cap-sgbd-consultas-24"><strong>24.</strong> Quantos créditos cada estudante cursa?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Para solução dessa consulta precisaremos das seguintes tabelas: <code class="docutils literal notranslate"><span class="pre">estudante</span></code>, <code class="docutils literal notranslate"><span class="pre">estudante_disciplina</span></code> e <code class="docutils literal notranslate"><span class="pre">disciplina</span></code>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_estudante</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">COUNT</span><span class="p">(</span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">SUM</span><span class="p">(</span><span class="n">creditos</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"></span>

<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>
<span class="w">                   </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | nome_estudante | num_disciplinas | total_creditos
-----------+----------------+-----------------+----------------
         1 | Eduardo        |               2 |             10
         2 | Maria          |               3 |             11
         3 | Eugenio        |               1 |              2
       ...   ...                          ...              ...
        35 | Josi           |               1 |              2
        36 | Antonio        |               4 |             10
<span class="hll">        37 | Zuleica        |               0 |
</span>(37 rows)
</pre></div>
</div>
<p>Repare no resultado acima que a linha destacada possui uma soma nula (<code class="docutils literal notranslate"><span class="pre">NULL</span></code>). A função <code class="docutils literal notranslate"><span class="pre">SUM</span></code> assim como as demais funções de agregação, com exceção de <code class="docutils literal notranslate"><span class="pre">COUNT</span></code>, retornam <code class="docutils literal notranslate"><span class="pre">NULL</span></code> quando todas as linhas possuem valores nulo. Se nosso intuito é não ter valores nulo no resultado, podemos utilizar a função <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> junto com a função <code class="docutils literal notranslate"><span class="pre">SUM</span></code>. Veja a nova versão da consulta:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_estudante</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">COUNT</span><span class="p">(</span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">         </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">creditos</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"></span>
</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>
<span class="w">                   </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | nome_estudante | num_disciplinas | total_creditos
-----------+----------------+-----------------+----------------
         1 | Eduardo        |               2 |             10
         2 | Maria          |               3 |             11
         3 | Eugenio        |               1 |              2
       ...   ...                          ...              ...
        35 | Josi           |               1 |              2
        36 | Antonio        |               4 |             10
<span class="hll">        37 | Zuleica        |               0 |              0
</span>(37 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>25.</strong> Qual estudante realizou o maior número de créditos e quantos são esses créditos?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Se alterarmos a cláusula <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> na <a class="reference internal" href="#cap-sgbd-consultas-24"><span class="std std-ref">consulta 24</span></a>, podemos ordenar de maneira decrescente pela coluna <code class="docutils literal notranslate"><span class="pre">total_creditos</span></code> e usar a cláusula <code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> para obter apenas a quantidade de linhas desejada:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_estudante</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">COUNT</span><span class="p">(</span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">creditos</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"></span>

<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>
<span class="w">                   </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="hll"><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"> </span><span class="k">DESC</span><span class="w"></span>
</span>
<span class="hll"><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> matricula | nome_estudante | num_disciplinas | total_creditos
-----------+----------------+-----------------+----------------
         7 | Manuel         |               5 |             15
(1 row)
</pre></div>
</div>
</details><hr class="docutils" />
<p><strong>26.</strong> Quantos estudantes estão matriculados em cada disciplina no ano de 2020?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Vamos começar construindo uma consulta que liste o código e título de cada disciplina bem como o número de matrículo do estudante associado:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">disciplina</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"></span>
<span class="w">   </span><span class="k">AND</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |      titulo       | matricula
--------+-------------------+-----------
      7 | Lingua Portuguesa |         4
      8 | Lingua Inglesa    |         5
      9 | Lingua Francesa   |         5
      5 | Geografia         |         6
      6 | Historia          |         6
      7 | Lingua Portuguesa |         6
      1 | Matemática        |         7
      8 | Lingua Inglesa    |         7
      9 | Lingua Francesa   |         7
      6 | Historia          |         7
      2 | Fisica            |         7
      1 | Matemática        |         8
      2 | Fisica            |         8
      3 | Bilogia           |         8
      4 | Quimica           |         9
      5 | Geografia         |         9
      8 | Lingua Inglesa    |        12
      9 | Lingua Francesa   |        12
      1 | Matemática        |        12
(19 rows)
</pre></div>
</div>
<p>A partir da consulta acima, podemos construir uma nova consulta incluindo uma cláusula <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> utilizando as colunas <code class="docutils literal notranslate"><span class="pre">codigo</span></code> e <code class="docutils literal notranslate"><span class="pre">titulo</span></code> da tabela <code class="docutils literal notranslate"><span class="pre">disciplina</span></code> para criação dos grupos de linhas para então utilizar a função <code class="docutils literal notranslate"><span class="pre">COUNT</span></code> na cláusula <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> para contar o número de linhas de cada grupo. Desta maneira, temos a seguinte consulta:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">disciplina</span><span class="w"></span>
<span class="w">   </span><span class="k">WHERE</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"></span>
<span class="w">     </span><span class="k">AND</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |      titulo       | num_estudantes
--------+-------------------+----------------
      1 | Matemática        |              3
      2 | Fisica            |              2
      3 | Bilogia           |              1
      4 | Quimica           |              1
      5 | Geografia         |              2
      6 | Historia          |              2
      7 | Lingua Portuguesa |              2
      8 | Lingua Inglesa    |              3
      9 | Lingua Francesa   |              3
(9 rows)
</pre></div>
</div>
<p>Podemos ainda ordenar o resultado pelas disciplinas mais cursadas e, em caso de empate, utilizar a ordem alfabética como critério de desempate:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">disciplina</span><span class="w"></span>
<span class="w">   </span><span class="k">WHERE</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="w"></span>
<span class="w">     </span><span class="k">AND</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |      titulo       | num_estudantes
--------+-------------------+----------------
      9 | Lingua Francesa   |              3
      8 | Lingua Inglesa    |              3
      1 | Matemática        |              3
      2 | Fisica            |              2
      5 | Geografia         |              2
      6 | Historia          |              2
      7 | Lingua Portuguesa |              2
      3 | Bilogia           |              1
      4 | Quimica           |              1
(9 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<div class="admonition tip">
<p class="admonition-title">Dica</p>
<p>Para mais detalhes das consultas de agregação, consulte o manual do PostgreSQL nas seções <a class="reference external" href="https://www.postgresql.org/docs/14/tutorial-agg.html">2.7. Aggregate Functions</a> e <a class="reference external" href="https://www.postgresql.org/docs/14/functions-aggregate.html">9.21. Aggregate Functions</a>.</p>
</div>
</section>
<section id="sub-consultas-sub-queries-ou-sub-selects">
<h2><span class="section-number">2.15.4. </span>Sub-Consultas (Sub-Queries ou Sub-Selects)<a class="headerlink" href="#sub-consultas-sub-queries-ou-sub-selects" title="Link permanente para este cabeçalho"></a></h2>
<p>A clásula <code class="docutils literal notranslate"><span class="pre">FROM</span></code> permite incluirmos não somenente nomes de tabelas mas também consultas SQL, que são denominadas de <strong>sub-consultas</strong> (<strong>sub-queries</strong> ou <strong>sub-selects</strong>). Uma subconsulta deve ser rotulada, isto é, devemos dar a ela um nome. Para compreender o uso deste recurso, nesta seção vamos construir algumas consultas que ilustram o uso de sub-consultas.</p>
<p><strong>27.</strong> Qual a média de créditos cursados pelos estudantes?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Para criar uma consulta que atenda a esta pergunta, podemos utilizar a <a class="reference internal" href="#cap-sgbd-consultas-24"><span class="std std-ref">consulta 24</span></a> como uma subconsulta e então tirar a média com a função <code class="docutils literal notranslate"><span class="pre">AVG</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">total_creditos</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">media_creditos</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
</span>
<span class="hll"><span class="w">              </span><span class="k">SELECT</span><span class="w"> </span><span class="n">matricula</span><span class="p">,</span><span class="w"> </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_estudante</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">                     </span><span class="k">COUNT</span><span class="p">(</span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_disciplinas</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">                     </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">creditos</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">                </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="w">                               </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>
</span>
<span class="hll"><span class="w">         </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">creditos_estudante</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>   media_creditos
--------------------
 5.7567567567567568
(1 row)
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Repare que para usarmos uma subconsulta, utilizamos os parênteses para delimitá-la <code class="docutils literal notranslate"><span class="pre">(...)</span></code> e demos o rótulo <code class="docutils literal notranslate"><span class="pre">creditos_estudante</span></code> a essa essa subconsulta.</p>
</div>
</details></section>
<hr class="docutils" />
<section id="funcoes-de-janela-window-functions">
<h2><span class="section-number">2.15.5. </span>Funções de Janela (Window Functions)<a class="headerlink" href="#funcoes-de-janela-window-functions" title="Link permanente para este cabeçalho"></a></h2>
<p>Além das funções de agregação existem funções que operam em um conjunto relacionado de linhas. Essas funções são chamadas de <strong>funções de janela</strong> (<strong>window functions</strong>). Duas funções de janela muito úteis são: <code class="docutils literal notranslate"><span class="pre">rank</span></code> e <code class="docutils literal notranslate"><span class="pre">dense_rank</span></code>. Vamos explorar o uso da função <code class="docutils literal notranslate"><span class="pre">dense_rank</span></code> nessa seção.</p>
<p><strong>28.</strong> Qual a posição (<em>ranking</em>) de cada aluno em relação ao número de créditos cursado ao longo dos anos?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Vamos começar construindo uma consulta que liste o ano de matricula, número de matrícula, nome e total de créditos cursados por cada estudante:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ano_matricula</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">matricula</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_estudante</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">creditos</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"></span>

<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>
<span class="w">                   </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ano_matricula</span><span class="p">,</span><span class="w"> </span><span class="n">matricula</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> ano_matricula | matricula | nome_estudante | total_creditos
---------------+-----------+----------------+----------------
          2019 |         1 | Eduardo        |             10
          2019 |         2 | Maria          |             11
           ...         ...   ...                         ...
          2022 |        30 | Zoraide        |              4
          2022 |        35 | Josi           |              2
(37 rows)
</pre></div>
</div>
<p>Em seguida, vamos construir uma nova consulta que utilize a consulta acima como subconsulta para podermos utilizar a função de janela <code class="docutils literal notranslate"><span class="pre">dense_rank</span></code> para criar partições no resultado:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">estudantes_creditos</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">         </span><span class="n">dense_rank</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ano_matricula</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">posicao_aluno</span><span class="w"></span>
</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>

<span class="w">                </span><span class="k">SELECT</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">data_matricula</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ano_matricula</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">matricula</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">estudante</span><span class="p">.</span><span class="n">nome</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nome_estudante</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">creditos</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_creditos</span><span class="w"></span>

<span class="w">                  </span><span class="k">FROM</span><span class="w"> </span><span class="n">estudante</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">matricula</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="w">              </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">matricula</span><span class="w"></span>

<span class="w">         </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w">  </span><span class="n">estudantes_creditos</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ano_matricula</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">posicao_aluno</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span> ano_matricula | matricula | nome_estudante | total_creditos | posicao_aluno
<span class="linenos"> 2</span>---------------+-----------+----------------+----------------+---------------
<span class="linenos"> 3</span>          2019 |         2 | Maria          |             11 |             1
<span class="linenos"> 4</span>          2019 |        36 | Antonio        |             10 |             2
<span class="linenos"> 5</span>          2019 |         1 | Eduardo        |             10 |             2
<span class="linenos"> 6</span>          2019 |        11 | Carla          |              4 |             3
<span class="linenos"> 7</span>          2019 |        34 | Joana          |              4 |             3
<span class="linenos"> 8</span>          2019 |        10 | Claudio        |              2 |             4
<span class="linenos"> 9</span>          2019 |        31 | Roberta        |              2 |             4
<span class="linenos">10</span>          2019 |         3 | Eugenio        |              2 |             4
<span class="linenos">11</span>          2019 |        32 | Roberto        |              2 |             4
<span class="linenos">12</span>          2019 |        37 | Zuleica        |              0 |             5
<span class="hll"><span class="linenos">13</span>          2020 |         7 | Manuel         |             15 |             1
</span><span class="hll"><span class="linenos">14</span>          2020 |         8 | Jose           |             12 |             2
</span><span class="hll"><span class="linenos">15</span>          2020 |        12 | Telma          |              9 |             3
</span><span class="hll"><span class="linenos">16</span>          2020 |         6 | Ana Clara      |              8 |             4
</span><span class="hll"><span class="linenos">17</span>          2020 |         9 | Ricardo        |              5 |             5
</span><span class="hll"><span class="linenos">18</span>          2020 |         4 | Luiza          |              4 |             6
</span><span class="hll"><span class="linenos">19</span>          2020 |         5 | Ana Maria      |              3 |             7
</span><span class="linenos">20</span>          2021 |        15 | Tassiana       |             10 |             1
<span class="linenos">21</span>          2021 |        18 | Carlos         |              7 |             2
<span class="linenos">22</span>          2021 |        19 | Fabio          |              7 |             2
<span class="linenos">23</span>          2021 |        16 | Julio          |              7 |             2
<span class="linenos">24</span>          2021 |        17 | Felipe         |              6 |             3
<span class="linenos">25</span>          2021 |        13 | Gilberto       |              6 |             3
<span class="linenos">26</span>          2021 |        14 | Lucia          |              3 |             4
<span class="linenos">27</span>          2021 |        33 | Antonio        |              2 |             5
<span class="hll"><span class="linenos">28</span>          2022 |        25 | Marcia         |             10 |             1
</span><span class="hll"><span class="linenos">29</span>          2022 |        27 | Everaldo       |             10 |             1
</span><span class="hll"><span class="linenos">30</span>          2022 |        26 | Luis           |             10 |             1
</span><span class="hll"><span class="linenos">31</span>          2022 |        28 | Katia          |             10 |             1
</span><span class="hll"><span class="linenos">32</span>          2022 |        23 | Gilberto       |              7 |             2
</span><span class="hll"><span class="linenos">33</span>          2022 |        30 | Zoraide        |              4 |             3
</span><span class="hll"><span class="linenos">34</span>          2022 |        24 | Marco          |              3 |             4
</span><span class="hll"><span class="linenos">35</span>          2022 |        29 | Emiliano       |              3 |             4
</span><span class="hll"><span class="linenos">36</span>          2022 |        35 | Josi           |              2 |             5
</span><span class="hll"><span class="linenos">37</span>          2022 |        21 | Joana          |              1 |             6
</span><span class="hll"><span class="linenos">38</span>          2022 |        20 | Mateus         |              1 |             6
</span><span class="hll"><span class="linenos">39</span>          2022 |        22 | Manuel         |              1 |             6
</span><span class="linenos">40</span>(37 rows)
</pre></div>
</div>
<p>Repare na consulta que a função de janela <code class="docutils literal notranslate"><span class="pre">dense_rank()</span></code> particiona as linhas resultantes da subconsulta pela coluna de saída <code class="docutils literal notranslate"><span class="pre">ano_matricula</span></code> e cria um <em>ranking</em> baseado na ordem dentro de cada partição pelo valor da coluna <code class="docutils literal notranslate"><span class="pre">total_creditos</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Dica</p>
<p>Refaça a consulta acima substituindo a função <code class="docutils literal notranslate"><span class="pre">dense_rank</span></code> pela função <code class="docutils literal notranslate"><span class="pre">rank</span></code> e analise o resultado.</p>
</div>
</details><hr class="docutils" />
<p><strong>29.</strong> Quais as disciplina mais cursadas em 2020?</p>
<details class="summary-solucao">
<summary>Solução:</summary><p>Vamos começar construindo uma consulta que nos forneça o total de alunos matriculados em cada disciplina no ano de 2020:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"></span>

<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |      titulo       | num_estudantes
--------+-------------------+----------------
      9 | Lingua Francesa   |              3
      8 | Lingua Inglesa    |              3
      1 | Matemática        |              3
      2 | Fisica            |              2
      5 | Geografia         |              2
      6 | Historia          |              2
      7 | Lingua Portuguesa |              2
      3 | Bilogia           |              1
      4 | Quimica           |              1
(9 rows)
</pre></div>
</div>
<p>Podemos usar uma função de janela para classificar as linhas. Para isso, precisamos de uma coluna que permita criar uma partição única na tabela. Uma maneira de fazer isso é introduzir artificialmente uma coluna extra com um valor inteiro constante:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="k">SELECT</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">particao</span><span class="w"></span>
</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |      titulo       | num_estudantes | particao
--------+-------------------+----------------+----------
      9 | Lingua Francesa   |              3 |        1
      8 | Lingua Inglesa    |              3 |        1
      1 | Matemática        |              3 |        1
      2 | Fisica            |              2 |        1
      5 | Geografia         |              2 |        1
      6 | Historia          |              2 |        1
      7 | Lingua Portuguesa |              2 |        1
      3 | Bilogia           |              1 |        1
      4 | Quimica           |              1 |        1
(9 rows)
</pre></div>
</div>
<p>Agora podemos utilizar essa consulta como uma subconsulta, como mostrado abaixo:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">codigo</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">titulo</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">num_estudantes</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">       </span><span class="n">dense_rank</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">particao</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">posicao</span><span class="w"></span>
</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>

<span class="hll"><span class="w">          </span><span class="k">SELECT</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">particao</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">           </span><span class="k">WHERE</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">        </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">       </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">subconsulta_rank</span><span class="p">;</span><span class="w"></span>
</span></pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |      titulo       | num_estudantes | posicao
--------+-------------------+----------------+---------
      1 | Matemática        |              3 |       1
      8 | Lingua Inglesa    |              3 |       1
      9 | Lingua Francesa   |              3 |       1
      5 | Geografia         |              2 |       2
      6 | Historia          |              2 |       2
      7 | Lingua Portuguesa |              2 |       2
      2 | Fisica            |              2 |       2
      4 | Quimica           |              1 |       3
      3 | Bilogia           |              1 |       3
(9 rows)
</pre></div>
</div>
<p>Finalmente, podemos criar mais um nível de consulta para selecionar apenas as linhas da posição <code class="docutils literal notranslate"><span class="pre">1</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>

<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">codigo</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">titulo</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">num_estudantes</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">dense_rank</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">particao</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">num_estudantes</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">posicao</span><span class="w"></span>

<span class="w">          </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>

<span class="w">                  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_estudantes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">particao</span><span class="w"></span>

<span class="w">                    </span><span class="k">FROM</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span><span class="w"></span>

<span class="w">                   </span><span class="k">WHERE</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">year</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">estudante_disciplina</span><span class="p">.</span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2020</span><span class="w"></span>

<span class="w">                </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">codigo</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">titulo</span><span class="w"></span>

<span class="w">               </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">subconsulta_1</span><span class="w"></span>

<span class="w">       </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">subconsulta_2</span><span class="w"></span>

<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">posicao</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> codigo |     titulo      | num_estudantes | posicao
--------+-----------------+----------------+---------
      1 | Matemática      |              3 |       1
      8 | Lingua Inglesa  |              3 |       1
      9 | Lingua Francesa |              3 |       1
(3 rows)
</pre></div>
</div>
</details><hr class="docutils" />
<div class="admonition tip">
<p class="admonition-title">Dica</p>
<p>Para mais detalhes das consultas de janela, consulte o manual do PostgreSQL nas seções <a class="reference external" href="https://www.postgresql.org/docs/14/tutorial-window.html">3.5. Window Functions</a> e <a class="reference external" href="https://www.postgresql.org/docs/14/functions-window.html">9.22. Window Functions</a>.</p>
</div>
</section>
<hr class="docutils" />
<section id="criando-tabelas-a-partir-de-consultas">
<h2><span class="section-number">2.15.6. </span>Criando Tabelas a partir de Consultas<a class="headerlink" href="#criando-tabelas-a-partir-de-consultas" title="Link permanente para este cabeçalho"></a></h2>
<p>Podemos utilizar os comandos <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> e <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> em conjunto, para criar tabelas a partir do resultado de consultas.</p>
<p>A sintaxe básica desse comando é a seguinte:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>CREATE TABLE nome-tabela AS consulta;
</pre></div>
</div>
<p>Vamos criar uma tabela chamada <code class="docutils literal notranslate"><span class="pre">prof_disciplina</span></code> a partir da relação entre professores e disciplinas:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">prof_disciplina</span><span class="w"> </span><span class="k">AS</span><span class="w"></span>

<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">nome</span><span class="p">,</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="o">*</span><span class="w"></span>
<span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">professor</span><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">disciplina</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">professor</span><span class="p">.</span><span class="n">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disciplina</span><span class="p">.</span><span class="n">professor_codigo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Se realizarmos uma consulta na nova tabela criada <code class="docutils literal notranslate"><span class="pre">prof_disciplina</span></code>, obteremos o seguinte resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>   nome   | codigo |      titulo       | creditos | professor_codigo
----------+--------+-------------------+----------+------------------
 Romildo  |      1 | Matemática        |        6 |                1
 Romildo  |      2 | Fisica            |        4 |                1
 Thales   |      3 | Bilogia           |        2 |                2
 Karine   |      4 | Quimica           |        3 |                3
 Tamara   |      5 | Geografia         |        2 |                4
 Tamara   |      6 | Historia          |        2 |                4
 Tamara   |      7 | Lingua Portuguesa |        4 |                4
 Carolina |      8 | Lingua Inglesa    |        2 |                5
 Carolina |      9 | Lingua Francesa   |        1 |                5
 Tamara   |     10 | Ciências          |        1 |                4
(10 rows)
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Rodapé">
        <a href="inserindo-dados.html" class="btn btn-neutral float-left" title="2.14. Inserindo Dados" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="atualizando-dados.html" class="btn btn-neutral float-right" title="2.16. Atualizando Dados" accesskey="n" rel="next">Próximo <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2022, Gilberto Queiroz.</p>
  </div>

  
<jinja2.runtime.BlockReference object at 0x7f1ca3a3afd0>
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/by-nc-sa.png" width="117" height="41"/></a> This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons “Attribution-NonCommercial-ShareAlike 4.0 International” license</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-165908761-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-165908761-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>